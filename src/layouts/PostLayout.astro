---
import '@/styles/global.css'
import type { PostLayoutProps } from '@/types'
import FormattedDate from '@/components/widgets/FormattedDate.astro'
import FootnoteScroll from '@/components/widgets/FootnoteScroll.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import Footer from '@/components/layout/Footer.astro'
import BackButton from '@/components/ui/BackButton.astro'
import TableOfContents from '@/components/ui/TableOfContents.astro'
import GradientMask from '@/components/ui/GradientMask.astro'
import ImageOptimizer from '@/components/ui/ImageOptimizer.astro'
import ImageViewer from '@/components/ui/ImageViewer.astro'
import GitHubCard from '@/components/ui/GitHubCard.astro'
import LinkCard from '@/components/ui/LinkCard.astro'
import NeoDBCard from '@/components/ui/NeoDBCard.astro'
import XPOST from '@/components/ui/XPOST.astro'
import CopyCode from '@/components/ui/CopyCode.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

import { themeConfig, COUPON_SYSTEM } from '@/config'

const { title, pubDate, readingTime, toc } = Astro.props as PostLayoutProps

const postSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || ''
const ogImage = `/open-graph/${postSlug}.png`
---

<BaseLayout title={`${title} Â· ${themeConfig.site.title}`} description={themeConfig.site.description} type="post">
  <BaseHead
    title={`${title} Â· ${themeConfig.site.title}`}
    description={themeConfig.site.description}
    ogImage={ogImage}
    slot="head"
  />
  <div class="post-container">
    <main>
      <div class="prose">
        <GradientMask />
        <BackButton />
        {themeConfig.post.toc && <TableOfContents toc={toc} />}
        <div class="title">
          <h1>{title}</h1>
          <div class="date">
            <FormattedDate date={pubDate} context="post" />
            {
              themeConfig.post.readingTime && readingTime && (
                <span class="reading-time">
                  <span class="separator">Â·</span>
                  {readingTime.text}
                </span>
              )
            }
          </div>
        </div>
        <article class="content">
          <slot />

          <div id="coupon-container" style="margin: 60px 0; text-align: center;">
            <a id="coupon-link" href="#" target="_blank" rel="noopener noreferrer" style="display: inline-block; transition: transform 0.2s; border-radius: 12px; overflow: hidden;">
              
              <img 
                src={COUPON_SYSTEM.bannerImageLight} 
                alt="ì½œë¡œì†Œ íŠ¹ë³„ ì¿ í°" 
                class="coupon-banner-light"
                style="width: 100%; height: auto; display: block;"
                onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'"
              />

              <img 
                src={COUPON_SYSTEM.bannerImageDark} 
                alt="ì½œë¡œì†Œ íŠ¹ë³„ ì¿ í°" 
                class="coupon-banner-dark"
                style="width: 100%; height: auto; display: none;" 
                onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'"
              />

            </a>
          </div>

          <style>
            /* ğŸŒ“ í…Œë§ˆë³„ ì´ë¯¸ì§€ ìŠ¤ìœ„ì¹­ ë¡œì§ */
            
            /* ë‹¤í¬ëª¨ë“œì¼ ë•Œ */
            :global(.dark) .coupon-banner-light {
              display: none !important;
            }
            :global(.dark) .coupon-banner-dark {
              display: block !important;
            }

            /* ë¼ì´íŠ¸ëª¨ë“œì¼ ë•Œ (ê¸°ë³¸) */
            .coupon-banner-light {
              display: block;
            }
            .coupon-banner-dark {
              display: none;
            }
          </style>

          <script define:vars={{ COUPON_SYSTEM }}>
  // ì¿ í° ì‹œìŠ¤í…œì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜ (ì´ë¦„ì„ ì§€ì–´ì¤Œ)
  function runCouponSystem() {
    const container = document.getElementById('coupon-container');
    const link = document.getElementById('coupon-link');

    // ìš”ì†Œê°€ ì—†ìœ¼ë©´(ë‹¤ë¥¸ í˜ì´ì§€ ë“±) ì¡°ìš©íˆ ì¢…ë£Œ
    if (!container || !link) return;

    // 1. ì›”ë³„ ë¦¬ì…‹ ë¡œì§
    const now = new Date();
    const currentMonthKey = `${now.getFullYear()}-${now.getMonth() + 1}`;
    const savedMonth = localStorage.getItem('coloso_coupon_month');
    let currentIdx = parseInt(localStorage.getItem('coloso_coupon_idx') || '0');

    if (savedMonth !== currentMonthKey) {
      currentIdx = 0;
      localStorage.setItem('coloso_coupon_idx', '0');
      localStorage.setItem('coloso_coupon_month', currentMonthKey);
    }

  // 2. ì¿ í° ì‹œìŠ¤í…œ ì ìš© ì—¬ë¶€ í™•ì¸ ë° ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
  let couponSection = ""; // ì¿ í° ì„¹ì…˜ ì´ˆê¸°í™” (êº¼ì ¸ ìˆìœ¼ë©´ ë¹ˆ ê°’)

  if (COUPON_SYSTEM?.enabled) {
    const codes = COUPON_SYSTEM.codes || [];
    
    if (codes.length > 0) {
      // ğŸ’¡ ì¿ í°ì´ ì¼œì ¸ ìˆê³  ì½”ë“œë„ ìˆì„ ë•Œë§Œ ì„¹ì…˜ ìƒì„± ë¡œì§ ì‹¤í–‰
      console.log("ğŸŸï¸ ì¿ í° ì‹œìŠ¤í…œ í™œì„±í™”: ì„¹ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.");
      
      // ì—¬ê¸°ì„œ ê¸°ì¡´ì˜ ì¿ í° ë ˆì´ì•„ì›ƒ ìƒì„± ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”
      // ì˜ˆ: couponSection = createCouponHtml(codes); 
    } else {
      console.warn("âš ï¸ ì¿ í° ê¸°ëŠ¥ì€ ì¼œì ¸ ìˆìœ¼ë‚˜ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ì„¹ì…˜ì„ ìŠ¤í‚µí•©ë‹ˆë‹¤.");
    }
  } else {
    console.log("â­ï¸ ì¿ í° ì‹œìŠ¤í…œ ë¹„í™œì„±í™”: ì¿ í° ì—†ì´ í¬ìŠ¤íŒ…ì„ ì§„í–‰í•©ë‹ˆë‹¤.");
  }

    // 3. ë§í¬ ìƒì„± ë° ì ìš©
    const activeIdx = currentIdx % codes.length;
    const activeCode = codes[activeIdx];
    
    // ğŸ”¥ í•µì‹¬: href ì†ì„±ì„ ì—¬ê¸°ì„œ ê°•ì œë¡œ ë°”ê¿”ì¤ë‹ˆë‹¤!
    link.href = `https://coloso.co.kr/account/coupon?redeemCode=${activeCode}`;
    
    // í™•ì¸ìš© ë¡œê·¸ (F12 ì½˜ì†”ì—ì„œ ë³´ì„)
    console.log(`ì¿ í° ì‹œìŠ¤í…œ ê°€ë™! ì ìš©ëœ ì½”ë“œ: ${activeCode}`);

    // 4. í´ë¦­ ì´ë²¤íŠ¸ (ë‹¤ìŒ ë°©ë¬¸ì„ ìœ„í•´ ìˆœë²ˆ ì¦ê°€)
    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
    link.onclick = null; 
    link.onclick = () => {
      console.log("ì¿ í° í´ë¦­ë¨! ë‹¤ìŒ ìˆœë²ˆìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.");
      localStorage.setItem('coloso_coupon_idx', (currentIdx + 1).toString());
    };
  }

  // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
  runCouponSystem();

  // 2. Astro í˜ì´ì§€ ì „í™˜(View Transitions) ì‹œ ì¬ì‹¤í–‰ (ì´ê²Œ ì¤‘ìš”!)
  document.addEventListener('astro:page-load', runCouponSystem);
</script>
