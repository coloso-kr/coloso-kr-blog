---
import '@/styles/global.css'
import type { PostLayoutProps } from '@/types'
import FormattedDate from '@/components/widgets/FormattedDate.astro'
import FootnoteScroll from '@/components/widgets/FootnoteScroll.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import Footer from '@/components/layout/Footer.astro'
import BackButton from '@/components/ui/BackButton.astro'
import TableOfContents from '@/components/ui/TableOfContents.astro'
import GradientMask from '@/components/ui/GradientMask.astro'
import ImageOptimizer from '@/components/ui/ImageOptimizer.astro'
import ImageViewer from '@/components/ui/ImageViewer.astro'
import GitHubCard from '@/components/ui/GitHubCard.astro'
import LinkCard from '@/components/ui/LinkCard.astro'
import NeoDBCard from '@/components/ui/NeoDBCard.astro'
import XPOST from '@/components/ui/XPOST.astro'
import CopyCode from '@/components/ui/CopyCode.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

import { themeConfig, COUPON_SYSTEM } from '@/config'

const { title, pubDate, readingTime, toc } = Astro.props as PostLayoutProps

const postSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || ''
const ogImage = `/open-graph/${postSlug}.png`
---

<BaseLayout title={`${title} Â· ${themeConfig.site.title}`} description={themeConfig.site.description} type="post">
  <BaseHead
    title={`${title} Â· ${themeConfig.site.title}`}
    description={themeConfig.site.description}
    ogImage={ogImage}
    slot="head"
  />
  <div class="post-container">
    <main>
      <div class="prose">
        <GradientMask />
        <BackButton />
        {themeConfig.post.toc && <TableOfContents toc={toc} />}
        <div class="title">
          <h1>{title}</h1>
          <div class="date">
            <FormattedDate date={pubDate} context="post" />
            {
              themeConfig.post.readingTime && readingTime && (
                <span class="reading-time">
                  <span class="separator">Â·</span>
                  {readingTime.text}
                </span>
              )
            }
          </div>
        </div>
        <article class="content">
          <slot />
<div id="coupon-container" style="margin: 60px 0; text-align: center; display: none;">
  <a id="coupon-link" href="#" target="_blank" rel="noopener noreferrer" style="display: inline-block; transition: transform 0.2s; border-radius: 12px; overflow: hidden;">
    
    <img 
      src={COUPON_SYSTEM.bannerImageLight} 
      alt="ì½œë¡œì†Œ íŠ¹ë³„ ì¿ í°" 
      class="coupon-banner-light"
      style="width: 100%; height: auto; display: block;"
      onmouseover="this.style.transform='scale(1.02)'"
      onmouseout="this.style.transform='scale(1)'"
    />

    <img 
      src={COUPON_SYSTEM.bannerImageDark} 
      alt="ì½œë¡œì†Œ íŠ¹ë³„ ì¿ í°" 
      class="coupon-banner-dark"
      style="width: 100%; height: auto; display: none;" 
      onmouseover="this.style.transform='scale(1.02)'"
      onmouseout="this.style.transform='scale(1)'"
    />

  </a>
  <p style="margin-top: 12px; opacity: 0.7; font-size: 0.85rem;">
    {COUPON_SYSTEM.expiryText}
  </p>
</div>

<style>
  /* ğŸŒ“ í…Œë§ˆë³„ ì´ë¯¸ì§€ ìŠ¤ìœ„ì¹­ ë¡œì§ */
  
  /* ë‹¤í¬ëª¨ë“œì¼ ë•Œ (.dark í´ë˜ìŠ¤ê°€ htmlì´ë‚˜ bodyì— ë¶™ëŠ” ê²½ìš°) */
  :global(.dark) .coupon-banner-light {
    display: none !important;
  }
  :global(.dark) .coupon-banner-dark {
    display: block !important;
  }

  /* ë¼ì´íŠ¸ëª¨ë“œì¼ ë•Œ (ê¸°ë³¸) */
  .coupon-banner-light {
    display: block;
  }
  .coupon-banner-dark {
    display: none;
  }
</style>

<script define:vars={{ COUPON_ROTATION: COUPON_SYSTEM.codes }}>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('coupon-container');
    const link = document.getElementById('coupon-link');

    // 1. ì›”ë³„ ë¦¬ì…‹ ë¡œì§
    const now = new Date();
    const currentMonthKey = `${now.getFullYear()}-${now.getMonth() + 1}`;
    const savedMonth = localStorage.getItem('coloso_coupon_month');
    let currentIdx = parseInt(localStorage.getItem('coloso_coupon_idx') || '0');

    if (savedMonth !== currentMonthKey) {
      currentIdx = 0;
      localStorage.setItem('coloso_coupon_idx', '0');
      localStorage.setItem('coloso_coupon_month', currentMonthKey);
    }

    // 2. ì¿ í° ìˆœí™˜ ë° ë§í¬ ì¡°ë¦½
    const codes = COUPON_SYSTEM.codes;
    const activeIdx = currentIdx % codes.length;
    const activeCode = codes[activeIdx];

    link.href = `https://coloso.co.kr/account/coupon?redeemCode=${activeCode}`;
    container.style.display = 'block';

    // 3. í´ë¦­ ì‹œ ë‹¤ìŒ ë²ˆí˜¸ ì €ì¥
    link.addEventListener('click', () => {
      localStorage.setItem('coloso_coupon_idx', (currentIdx + 1).toString());
    });
  });
</script>
        </article>
      </div>
    </main>
    <ImageOptimizer />
    <FootnoteScroll />
    <CopyCode />
    <GitHubCard />
    <XPOST />
    <NeoDBCard />
    {themeConfig.post.imageViewer && <ImageViewer />}
    {themeConfig.post.linkCard && <LinkCard />}
    {themeConfig.general.footer && <Footer />}
  </div>
</BaseLayout>

<style>
  .post-container {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .post-container main {
    flex: 1;
  }
</style>
