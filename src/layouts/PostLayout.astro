---
import '@/styles/global.css'
import type { PostLayoutProps } from '@/types'
import FormattedDate from '@/components/widgets/FormattedDate.astro'
import FootnoteScroll from '@/components/widgets/FootnoteScroll.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import Footer from '@/components/layout/Footer.astro'
import BackButton from '@/components/ui/BackButton.astro'
import TableOfContents from '@/components/ui/TableOfContents.astro'
import GradientMask from '@/components/ui/GradientMask.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

import { themeConfig, COUPON_SYSTEM } from '@/config'

const { title, pubDate, readingTime, toc } = Astro.props as PostLayoutProps

const postSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || ''
const ogImage = `/open-graph/${postSlug}.png`
---

<BaseLayout title={`${title} Â· ${themeConfig.site.title}`} description={themeConfig.site.description} type="post">
  <BaseHead
    title={`${title} Â· ${themeConfig.site.title}`}
    description={themeConfig.site.description}
    ogImage={ogImage}
    slot="head"
  />
  <div class="post-container">
    <main>
      <div class="prose">
        <GradientMask />
        <BackButton />
        {themeConfig.post.toc && <TableOfContents toc={toc} />}
        
        <div class="title">
          <h1>{title}</h1>
          <div class="date">
            <FormattedDate date={pubDate} context="post" />
            {
              themeConfig.post.readingTime && readingTime && (
                <span class="reading-time">
                  <span class="separator">Â·</span>
                  {readingTime.text}
                </span>
              )
            }
          </div>
        </div>

        <article class="content">
          <slot />
        </article>
      </div>
    </main>
    <Footer />
  </div>
</BaseLayout>

<script define:vars={{ COUPON_SYSTEM }}>
  function runCouponSystem() {
return; // ğŸ‘ˆ ì´ ì¤„ë§Œ ì¶”ê°€í•˜ì„¸ìš”. ì•„ë˜ ì½”ë“œê°€ ì•„ì˜ˆ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    if (!COUPON_SYSTEM?.enabled || !COUPON_SYSTEM.codes) return;

    const sections = document.querySelectorAll('.coupon-section');

    sections.forEach(section => {
      const type = section.getAttribute('data-coupon-type');
      if (!type) return;

      const codesArray = COUPON_SYSTEM.codes[type];
      if (!codesArray || codesArray.length === 0) return;

      const couponKey = `coloso_idx_${type}`;
      let currentIdx = parseInt(localStorage.getItem(couponKey) || '0');
      const activeCode = codesArray[currentIdx % codesArray.length];
      const redeemLink = `https://coloso.co.kr/account/coupon?redeemCode=${activeCode}`;

      section.innerHTML = `
        <div style="text-align: center; margin: 60px 0; padding: 40px 0; border-top: 1px solid #eee;">
          <p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 20px;">ğŸ íŠ¹ë³„ í˜œíƒ ì•ˆë‚´</p>
          <h1 style="margin: 20px 0;">
            <a href="${redeemLink}"
               style="color: #0070f3; text-decoration: underline; font-weight: bold; font-size: 32px;"
               onclick="localStorage.setItem('${couponKey}', ${currentIdx + 1})">
               ì£¼ê°„ ë² ìŠ¤íŠ¸ ì‹œí¬ë¦¿ ì¿ í° ë°›ê¸°
            </a>
          </h1>
          <p style="font-weight: 600; color: #888;">í´ë¦­ ì‹œ ${type === '30000' ? '3ë§Œì›' : '4ë§Œì›'} í• ì¸ ì¿ í°ì´ ì¦‰ì‹œ ë“±ë¡ë©ë‹ˆë‹¤.</p>
        </div>
      `;
    });
  }

  runCouponSystem();
  document.addEventListener('astro:page-load', runCouponSystem);
</script>
