---
import '@/styles/global.css'
import type { PostLayoutProps } from '@/types'
import FormattedDate from '@/components/widgets/FormattedDate.astro'
import FootnoteScroll from '@/components/widgets/FootnoteScroll.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import Footer from '@/components/layout/Footer.astro'
import BackButton from '@/components/ui/BackButton.astro'
import TableOfContents from '@/components/ui/TableOfContents.astro'
import GradientMask from '@/components/ui/GradientMask.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

import { themeConfig, COUPON_SYSTEM } from '@/config'

const { title, pubDate, readingTime, toc } = Astro.props as PostLayoutProps

const postSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || ''
const ogImage = `/open-graph/${postSlug}.png`
---

<BaseLayout title={`${title} Â· ${themeConfig.site.title}`} description={themeConfig.site.description} type="post">
  <BaseHead
    title={`${title} Â· ${themeConfig.site.title}`}
    description={themeConfig.site.description}
    ogImage={ogImage}
    slot="head"
  />
  <div class="post-container">
    <main>
      <div class="prose">
        <GradientMask />
        <BackButton />
        {themeConfig.post.toc && <TableOfContents toc={toc} />}
        
        <div class="title">
          <h1>{title}</h1>
          <div class="date">
            <FormattedDate date={pubDate} context="post" />
            {
              themeConfig.post.readingTime && readingTime && (
                <span class="reading-time">
                  <span class="separator">Â·</span>
                  {readingTime.text}
                </span>
              )
            }
          </div>
        </div>

        <article class="content">
          <slot />

          {/* ğŸ ì¿ í° ì‹œìŠ¤í…œ: í…ìŠ¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ì „ë©´ ìˆ˜ì • */}
          {COUPON_SYSTEM.enabled && (
            <div id="coupon-container" style="margin: 80px 0; text-align: center; border-top: 1px solid #eee; padding-top: 40px;">
              <p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 20px;">ğŸ íŠ¹ë³„ í˜œíƒ ì•ˆë‚´</p>
              
              <a id="coupon-link" href="#" target="_blank" rel="noopener noreferrer" style="display: inline-block; text-decoration: none;">
                <h1 id="coupon-text" style="font-size: 36px; font-weight: 800; text-decoration: underline; color: #0070f3; margin: 0; line-height: 1.2;">
                  ì£¼ê°„ ë² ìŠ¤íŠ¸ ì‹œí¬ë¦¿ ì¿ í° ë°›ê¸°
                </h1>
              </a>
              
              <p style="margin-top: 20px; font-weight: 600; color: #444;">
                ìœ„ ë§í¬ë¥¼ í´ë¦­í•˜ë©´ ì´ë²ˆ ë‹¬ ì¿ í°ì´ ìˆœì°¨ì ìœ¼ë¡œ ì¦‰ì‹œ ë“±ë¡ë©ë‹ˆë‹¤.
              </p>
              <p style="font-size: 0.9rem; color: #888;">
                (ì´ë¯¸ ì‚¬ìš©í•œ ì¿ í°ì´ë¼ë©´ ë‹¤ì‹œ í´ë¦­í•˜ì—¬ ìƒˆ ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”!)
              </p>
            </div>
          )}
        </article>
      </div>
    </main>
    <Footer />
  </div>
</BaseLayout>

<script define:vars={{ COUPON_SYSTEM }}>
  function runCouponSystem() {
    if (!COUPON_SYSTEM?.enabled) return;
    
    const container = document.getElementById('coupon-container');
    const link = document.getElementById('coupon-link');
    if (!container || !link) return;

    const now = new Date();
    const currentMonthKey = `${now.getFullYear()}-${now.getMonth() + 1}`;
    const savedMonth = localStorage.getItem('coloso_coupon_month');
    let currentIdx = parseInt(localStorage.getItem('coloso_coupon_idx') || '0');

    // ë‹¬ì´ ë°”ë€Œë©´ ì¸ë±ìŠ¤ ì´ˆê¸°í™”
    if (savedMonth !== currentMonthKey) {
      currentIdx = 0;
      localStorage.setItem('coloso_coupon_idx', '0');
      localStorage.setItem('coloso_coupon_month', currentMonthKey);
    }

    const codes = COUPON_SYSTEM.codes || [];
    if (codes.length === 0) return;

    // í˜„ì¬ ì¸ë±ìŠ¤ì— ë§ëŠ” ì½”ë“œ ì„¤ì •
    const activeIdx = currentIdx % codes.length;
    const activeCode = codes[activeIdx];
    
    // ë¦¬ë”¤ í˜ì´ì§€ë¡œ ì—°ê²°
    link.href = `https://coloso.co.kr/sign-in?redeemCode=${activeCode}`;
    
    // í´ë¦­ ì‹œ ë‹¤ìŒ ë²ˆí˜¸ë¡œ ë„˜ì–´ê°€ë„ë¡ ì¸ë±ìŠ¤ ì¦ê°€
    link.onclick = () => {
      localStorage.setItem('coloso_coupon_idx', (currentIdx + 1).toString());
    };
  }

  // í˜ì´ì§€ ë¡œë“œ ë° Astro í˜ì´ì§€ ì „í™˜ ì‹œ ì‹¤í–‰
  runCouponSystem();
  document.addEventListener('astro:page-load', runCouponSystem);
</script>
